<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP-HACK</title>

    <script type="module" src="https://unpkg.com/esp-web-tools@9.4.3/dist/web/install-button.js?module"></script>

    <style>
        :root {
            --bg: #000000;
            --text: #ffffff;
            --border: #555555;
        }

        * { margin:0; padding:0; box-sizing:border-box; }

        body {
            background: #000;
            color: var(--text);
            font-family: 'Courier New', monospace;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            user-select: none;
        }

        .container {
            width: 100%;
            max-width: 680px;
            padding: 80px 30px 70px;
            border: 3px solid var(--border);
            border-radius: 24px;
            background: #0a0a0a;
            box-shadow: 0 0 50px rgba(255,255,255,0.07);
            position: relative;
            z-index: 2;
        }

        .header {
            text-align: center;
            margin-bottom: 55px;
        }

        .header h1 {
            font-family: 'Fixedsys', 'Courier New', monospace;
            font-size: 4.2rem;
            letter-spacing: 12px;
            text-transform: uppercase;
            text-shadow: 0 0 12px #fff;
        }

        .header p {
            font-size: 1.15rem;
            opacity: 0.75;
            letter-spacing: 3px;
            margin-top: 8px;
        }

        .choice {
            display: flex;
            justify-content: space-between;
            gap: 30px;
            max-width: 520px;
            margin: 50px auto;
        }

        .option-btn {
            flex: 1;
            padding: 18px 30px;
            background: transparent;
            border: 3px solid var(--border);
            border-radius: 16px;
            color: var(--text);
            font-family: 'Fixedsys', 'Courier New', monospace;
            font-size: 1.45rem;
            cursor: pointer;
            transition: all 0.4s ease;
            text-align: center;
        }

        .option-btn:hover { border-color: #888; }
        .option-btn.active {
            border-color: #fff;
            color: #fff;
            box-shadow: 0 0 30px rgba(255,255,255,0.5);
        }

        esp-web-install-button {
            display: block;
            margin: 60px auto 0;
            width: 100%;
            max-width: 420px;
        }

        esp-web-install-button::part(button) {
            background: transparent;
            color: #fff;
            border: 3px solid #fff;
            border-radius: 16px;
            font-family: 'Fixedsys', 'Courier New', monospace;
            font-size: 1.65rem;
            padding: 22px 60px;
            text-transform: uppercase;
            letter-spacing: 6px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.4s ease;
        }

        esp-web-install-button::part(button):hover {
            background: #fff;
            color: #000;
            box-shadow: 0 0 40px #fff;
        }

        #version-info {
            text-align: center;
            margin-top: 40px;
            font-size: 1.15rem;
            opacity: 0.75;
            min-height: 28px;
        }

        .crt {
            position: fixed;
            inset: 0;
            z-index: -1;
            pointer-events: none;
            background: 
                linear-gradient(rgba(255,255,255,0.025) 50%, transparent 50%),
                linear-gradient(transparent 50%, rgba(255,255,255,0.015) 50%);
            background-size: 100% 4px;
            animation: 
                scan-up 7s linear infinite,
                flicker 0.12s infinite alternate;
        }

        @keyframes scan-up {
            0%   { background-position: 0 100vh; }
            100% { background-position: 0 0; }
        }

        @keyframes flicker {
            0%   { opacity: 0.96; }
            100% { opacity: 1; }
        }

        .crt::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center, transparent 70%, rgba(0,0,0,0.6) 100%);
        }
    </style>
</head>
<body>

<div class="crt"></div>

<div class="container">
    <div class="header">
        <h1>ESP-HACK</h1>
        <p>SH1106 / SSD1306</p>
    </div>

    <div class="choice">
        <button class="option-btn active" data-type="sh">SH1106</button>
        <button class="option-btn" data-type="ssd">SSD1306</button>
    </div>

    <esp-web-install-button id="install-btn"></esp-web-install-button>

    <div id="version-info">Загрузка версий с GitHub...</div>
</div>

<script>
    const installBtn = document.getElementById('install-btn');
    const optionBtns = document.querySelectorAll('.option-btn');
    const versionInfo = document.getElementById('version-info');

    let latestFirmwares = { sh: null, ssd: null };
    let currentType = 'sh';

    // Получаем самые свежие прошивки с GitHub
    async function loadLatestFirmwares() {
        try {
            const response = await fetch('https://api.github.com/repos/Teapot174/ESP-HACK/releases');
            const releases = await response.json();

            let maxVerSH = -1;
            let maxVerSSD = -1;

            releases.forEach(release => {
                release.assets.forEach(asset => {
                    const name = asset.name.toLowerCase();
                    const match = name.match(/v(\d+\.\d+)/);
                    if (!match) return;
                    const ver = parseFloat(match[1]);

                    if (name.includes('-sh.bin') && ver > maxVerSH) {
                        maxVerSH = ver;
                        latestFirmwares.sh = {
                            url: asset.browser_download_url,
                            version: match[0]
                        };
                    }
                    if (name.includes('-ssd.bin') && ver > maxVerSSD) {
                        maxVerSSD = ver;
                        latestFirmwares.ssd = {
                            url: asset.browser_download_url,
                            version: match[0]
                        };
                    }
                });
            });

            updateVersionDisplay();
            updateFirmware(); 
        } catch (err) {
            versionInfo.textContent = 'Не удалось загрузить версии с GitHub';
            console.error(err);
        }
    }

    function createManifest(fw) {
        const manifest = {
            "name": "ESP-HACK",
            "new_install_prompt_erase": true,
            "builds": [{
                "chipFamily": "ESP32",
                "parts": [{ "path": fw.url, "offset": 0 }]
            }]
        };

        const blob = new Blob([JSON.stringify(manifest, null, 2)], { type: 'application/json' });
        return URL.createObjectURL(blob);
    }

    function updateFirmware() {
        const fw = currentType === 'sh' ? latestFirmwares.sh : latestFirmwares.ssd;
        if (!fw) return;

        const oldUrl = installBtn.getAttribute('manifest');
        if (oldUrl) URL.revokeObjectURL(oldUrl);

        installBtn.setAttribute('manifest', createManifest(fw));
    }

    function updateVersionDisplay() {
        const fw = currentType === 'sh' ? latestFirmwares.sh : latestFirmwares.ssd;
        if (fw) {
            versionInfo.textContent = `Latest: ${fw.version} (${currentType.toUpperCase()})`;
        }
    }

    optionBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            optionBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentType = btn.dataset.type;
            updateFirmware();
            updateVersionDisplay();
        });
    });

    loadLatestFirmwares();

    console.log = console.warn = console.error = () => {};
</script>

</body>
</html>
